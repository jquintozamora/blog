<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Accept-CH" content="DPR, Viewport-Width, Width"><title>SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView | José Quinto</title><meta name="description" content="SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><meta property="og:image" content="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/featured.png"><meta name="twitter:image" content="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/featured.png"><meta property="fb:app_id" content="155567495101835"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/" property="og:url"><meta name="twitter:title" content="SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView | José Quinto" property="og:title"><meta name="twitter:site" content="@jquintozamora"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/"><meta property="og:title" content="SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView | José Quinto"><link rel="canonical" href="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/"><link rel="author" href="https://plus.google.com/u/0/108403117712061507579"><link rel="alternate" type="application/rss+xml" title="Jose Quinto" href="https://blog.josequinto.com/feed.rss"><meta name="theme-color" content="#ffffff"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.1"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.js" defer></script><script>var GLOBAL = { 
  root: '/',
  algolia: {"appId":"C7MOFESP3V","apiKey":"cdc4a9b7af864c710f2d3da5caf59eec","indexName":"dev_JQBLOG","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><div id="bodyWrapper"><div id="content-outer"><div id="top-container" style="background-image: url(/background.svg)"><div id="page-header"><span class="pull-left"> <a class="brand" href="/"><img class="brand-image" src="/jose-quinto.png"><div class="brand-name">José Quinto</div></a></span><i class="fa fa-share toggle-social" aria-hidden="true"></i><div class="socialicons" id="header-social-icons"><a class="social-icon" href="https://twitter.com/jquintozamora" target="_blank" rel="noopener"><i class="fa fa-twitter"></i></a><a class="social-icon" href="https://github.com/jquintozamora" target="_blank" rel="noopener"><i class="fa fa-github"></i></a><a class="social-icon" href="https://codepen.io/jquintozamora" target="_blank" rel="noopener"><i class="fa fa-codepen"></i></a><a class="social-icon" href="https://www.linkedin.com/in/jquintozamora" target="_blank" rel="noopener"><i class="fa fa-linkedin"></i></a><a class="social-icon" href="https://stackoverflow.com/users/5015774/jos%C3%A9-quinto-zamora?tab=profile" target="_blank" rel="noopener"><i class="fa fa-stack-overflow"></i></a><a class="social-icon" href="https://blog.josequinto.com/feed.rss" target="_blank" rel="noopener"><i class="fa fa-rss"></i></a></div><a class="social-icon search"><i class="fa fa-search"></i></a><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Search posts:</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/about.html">About</a></span></div><div id="post-info"><div id="post-title">SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2015-01-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/taxonomy/Article/">Article</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/"></span></a></div></div></div><div class="layout" id="content-inner"><section class="articlePostContainer"><nav class="sidebar-toc"><div class="sidebar-toc__title">Contents</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Data-Access-Layer"><span class="toc-number">2.</span> <span class="toc-text">Data Access Layer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Presentation-Layer"><span class="toc-number">3.</span> <span class="toc-text">Presentation Layer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Export-to-Excel"><span class="toc-number">4.</span> <span class="toc-text">Export to Excel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Download"><span class="toc-number">5.</span> <span class="toc-text">Download</span></a></li></ol></div></nav><section class="postArticle"><article id="post"><div class="post-featuredImage"><img src="featured.png" width="auto" height="auto"></div><div id="post-content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>I had a requirement to create an <code>Aggregation Web Part</code> to combine information from different sites in the same site collection. Moreover, it need to be represented as a table with sortable, filterable and exportable features enabled. Basically similar behavior we have in SharePoint OOTB lists.</p>
<p>We have here three main challenges:</p>
<ul>
<li>Data Access Layer: get all the information thru Site Collection efficiently.</li>
<li>Presentation Layer: display all the information in a table with sortable and filterable columns.</li>
<li>Export to excel: Add this feature to table.</li>
</ul>
<h2 id="Data-Access-Layer"><a href="#Data-Access-Layer" class="headerlink" title="Data Access Layer"></a>Data Access Layer</h2><p>The best object to get information thru all Site Collection in terms of performance is SPSiteDataQuery.</p>
<blockquote>
<p>It is <strong>very important</strong> to add <code>ServerTemplate</code>
    <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q.Lists = <span class="string">"&lt;Lists ServerTemplate='100' BaseType='0' MaxListLimit='0' /&gt;"</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>Adding ServerTemplate: 19 seconds
Without adding ServerTemplate: 6 seconds</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DataTable <span class="title">PopulateDatasetSPSiteDataQuery</span>(<span class="params"><span class="keyword">string</span> sortExpression, <span class="keyword">string</span> contentType, <span class="keyword">string</span> fieldsNames</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(contentType))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (HttpRuntime.Cache[CACHE_KEY] == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> status = <span class="string">"The following items are NOT fetched from the cache"</span>;</span><br><span class="line">            <span class="comment">//In order to know all field Internal Names: $dependenciesList.Fields | Select InternalName</span></span><br><span class="line">            SPSiteDataQuery q = <span class="keyword">new</span> SPSiteDataQuery();</span><br><span class="line">            <span class="keyword">string</span>[] fields = getFieldsNames(fieldsNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> nameField, typeField;</span><br><span class="line"></span><br><span class="line">            q.ViewFields = <span class="string">"&lt;FieldRef Name='Title' /&gt;"</span>;</span><br><span class="line">            q.ViewFields += <span class="string">"&lt;FieldRef Name='Team' Type='Lookup' Nullable='True' /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fields != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    nameField = fields[i].Split(<span class="string">','</span>)[<span class="number">1</span>].ToString();</span><br><span class="line">                    typeField = fields[i].Split(<span class="string">','</span>)[<span class="number">2</span>].ToString();</span><br><span class="line">                    q.ViewFields += String.Concat(<span class="string">"&lt;FieldRef Name='"</span>, nameField, <span class="string">"' Type='"</span>, typeField, <span class="string">"' Nullable='True' /&gt;"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            q.ViewFields += <span class="string">"&lt;FieldRef Name='FileDirRef'  Nullable='True' /&gt;"</span>;</span><br><span class="line">            <span class="comment">// BaseType =&gt; GenericList = 0, DocumentLibrary = 1, DiscussionForum = 3, VoteOfSurvey = 4, IssueList = 5</span></span><br><span class="line">            q.Lists = <span class="string">"&lt;Lists ServerTemplate='100' BaseType='0' MaxListLimit='0' /&gt;"</span>; </span><br><span class="line">            q.Webs = <span class="string">"&lt;Webs Scope='SiteCollection' /&gt;"</span>; <span class="comment">// alcance de la busqueda</span></span><br><span class="line">            q.Query = String.Concat(<span class="string">"&lt;Where&gt;&lt;Eq&gt;&lt;FieldRef Name='ContentType' /&gt;&lt;Value Type='Text'&gt;"</span>, contentType, <span class="string">"&lt;/Value&gt;&lt;/Eq&gt;&lt;/Where&gt;"</span>); </span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (SPWeb w = <span class="keyword">new</span> SPSite(String.Concat(HttpContext.Current.Request.Url.Scheme, <span class="string">"://"</span>, HttpContext.Current.Request.Url.Authority, <span class="string">"/PWA/"</span>)).OpenWeb())</span><br><span class="line">            &#123;</span><br><span class="line">                DataTable oDataTable = <span class="keyword">new</span> DataTable();</span><br><span class="line">                <span class="keyword">using</span> (SPMonitoredScope populateDataSet = <span class="keyword">new</span> SPMonitoredScope(<span class="string">"GetSiteData_PopulateData"</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        oDataTable = w.GetSiteData(q);</span><br><span class="line">                        Logger.LogInfo(Logger.Constants.LogSource.LOGSRC_COMMON, <span class="string">"Number of items from GetSiteData_PopulateData: "</span> + oDataTable.Rows.Count);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception)</span><br><span class="line">                    &#123;</span><br><span class="line">                        oDataTable = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (oDataTable != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    newTable.Columns.Add(<span class="string">"ProjectName"</span>);</span><br><span class="line">                    <span class="keyword">foreach</span> (DataColumn col <span class="keyword">in</span> oDataTable.Columns) <span class="comment">// Loop over the rows.</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        newTable.Columns.Add(col.ColumnName);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (DataRow row <span class="keyword">in</span> oDataTable.Rows) <span class="comment">// Loop over the items.</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        DataRow newRow = newTable.Rows.Add();</span><br><span class="line"></span><br><span class="line">                        newRow[<span class="string">"ProjectName"</span>] = row[<span class="string">"FileDirRef"</span>].ToString().Split(<span class="string">'/'</span>)[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">foreach</span> (DataColumn col <span class="keyword">in</span> oDataTable.Columns) <span class="comment">// Loop over the rows.</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">string</span> initialValue = row[col.ColumnName].ToString();</span><br><span class="line">                            <span class="keyword">string</span> finalValue = initialValue;</span><br><span class="line">                            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(initialValue))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (col.ColumnName.Equals(<span class="string">"Team"</span>) || col.ColumnName.Equals(<span class="string">"Depends_x0020_On"</span>))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">try</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        SPFieldLookupValue lookupGroup = <span class="keyword">new</span> SPFieldLookupValue(initialValue);</span><br><span class="line">                                        finalValue = lookupGroup.LookupValue;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">catch</span> (Exception) &#123; &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (col.ColumnName.Equals(<span class="string">"Due_x0020_Date"</span>) || col.ColumnName.Equals(<span class="string">"DueDate"</span>))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    finalValue = <span class="string">""</span>;</span><br><span class="line">                                    DateTime date;</span><br><span class="line">                                    <span class="keyword">if</span> (DateTime.TryParse(row[col.ColumnName].ToString(), <span class="keyword">out</span> date))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        finalValue = date.ToString(<span class="string">"dd/MM/yyyy"</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (col.ColumnName.Equals(<span class="string">"AssignedTo"</span>))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">try</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        SPFieldUserValue userValue = <span class="keyword">new</span> SPFieldUserValue(w, initialValue);</span><br><span class="line">                                        finalValue = userValue.LookupValue;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">catch</span> (Exception) &#123; &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                            newRow[col.ColumnName] = finalValue;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            HttpRuntime.Cache.Add(CACHE_KEY,</span><br><span class="line">            newTable,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            DateTime.MaxValue,</span><br><span class="line">            TimeSpan.FromMinutes(CACHE_MINUTES),</span><br><span class="line">            System.Web.Caching.CacheItemPriority.Default, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> status = <span class="string">"The following items ARE fetched from the cache!"</span>;</span><br><span class="line">            newTable = (DataTable)HttpRuntime.Cache[CACHE_KEY];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//clean up the sort expression if needed - the sort descending </span></span><br><span class="line">    <span class="comment">//menu item causes the double in some cases </span></span><br><span class="line">    <span class="keyword">if</span> (sortExpression.ToLowerInvariant().EndsWith(<span class="string">"desc desc"</span>))</span><br><span class="line">        sortExpression = sortExpression.Substring(<span class="number">0</span>, sortExpression.Length - <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//need to handle the actual sorting of the data</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(sortExpression))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            DataView view = <span class="keyword">new</span> DataView(newTable);</span><br><span class="line">            view.Sort = sortExpression;</span><br><span class="line">            DataTable newTable2 = view.ToTable();</span><br><span class="line">            newTable.Clear();</span><br><span class="line">            newTable.Merge(newTable2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            LiteralControl literal = <span class="keyword">new</span> LiteralControl(<span class="keyword">string</span>.Concat(<span class="string">"SortExpression: "</span>, ex.ToString()));</span><br><span class="line">            <span class="keyword">this</span>.Controls.Add(literal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<h2 id="Presentation-Layer"><a href="#Presentation-Layer" class="headerlink" title="Presentation Layer"></a>Presentation Layer</h2><p>After evaluating different alternatives the easiest approach is to use <strong>SPGridView</strong> because it provides OOTB features like filtering and sorting.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Notice that PopulateDatasetSPSiteDataQuery is called from this.Controls</span></span><br><span class="line">gridDS = <span class="keyword">new</span> ObjectDataSource();</span><br><span class="line">gridDS.ID = <span class="string">"gridDS"</span>;</span><br><span class="line">gridDS.SelectMethod = <span class="string">"PopulateDatasetSPSiteDataQuery"</span>;</span><br><span class="line">gridDS.TypeName = <span class="keyword">this</span>.GetType().AssemblyQualifiedName;</span><br><span class="line">gridDS.EnableViewState = <span class="literal">false</span>;</span><br><span class="line">gridDS.SortParameterName = <span class="string">"SortExpression"</span>;</span><br><span class="line">gridDS.SelectParameters.Add(<span class="string">"contentType"</span>, ContentType);</span><br><span class="line">gridDS.SelectParameters.Add(<span class="string">"fieldsNames"</span>, FieldsNames);</span><br><span class="line">gridDS.FilterExpression = FilterExpression;</span><br><span class="line"><span class="keyword">this</span>.Controls.Add(gridDS);</span><br><span class="line"></span><br><span class="line">oGrid = <span class="keyword">new</span> SPGridView();</span><br><span class="line">oGrid.ID = <span class="string">"oGrid"</span>;</span><br><span class="line">oGrid.AutoGenerateColumns = <span class="literal">false</span>;</span><br><span class="line">oGrid.EnableViewState = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Disable Pagging</span></span><br><span class="line">oGrid.AllowPaging = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sorting Code</span></span><br><span class="line">oGrid.AllowSorting = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//filtering </span></span><br><span class="line">oGrid.AllowFiltering = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">StringBuilder filterDataFields = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">FieldsArray = getFieldsNames(FieldsNames);</span><br><span class="line">filterDataFields.Append(<span class="string">"ProjectName"</span>);             </span><br><span class="line">filterDataFields.Append(<span class="string">","</span>);</span><br><span class="line">filterDataFields.Append(<span class="string">"Title"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Fields in Object Data Source = ProjectName, ListId, WebId, ID, Title, Team, Depends_x0020_On, Due_x0020_Date, Status, FileDirRef, Notes</span></span><br><span class="line"><span class="keyword">if</span> (FieldsArray != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FieldsArray.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> field = FieldsArray[i].Split(<span class="string">','</span>)[<span class="number">1</span>].ToString();</span><br><span class="line">        <span class="keyword">if</span> (!field.Equals(<span class="string">"Notes"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            filterDataFields.Append(<span class="string">","</span>);</span><br><span class="line">            filterDataFields.Append(field);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//oGrid.FilterDataFields = "ProjectName,Title,Team,Depends_x0020_On,Due_x0020_Date,Status";</span></span><br><span class="line">oGrid.FilterDataFields = filterDataFields.ToString();</span><br><span class="line">oGrid.FilteredDataSourcePropertyName = <span class="string">"FilterExpression"</span>;</span><br><span class="line">oGrid.FilteredDataSourcePropertyFormat = <span class="string">"&#123;1&#125; = '&#123;0&#125;'"</span>;</span><br><span class="line"></span><br><span class="line">oGrid.Sorting += <span class="keyword">new</span> GridViewSortEventHandler(gridView_Sorting);</span><br><span class="line">oGrid.RowDataBound += <span class="keyword">new</span> GridViewRowEventHandler(gridView_RowDataBound);</span><br><span class="line"></span><br><span class="line">AddColumnsToSPGridView();</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> </span></span><br><span class="line"><span class="comment">//Add logic to make a custom data set and preprocess the information adapting the texts </span></span><br><span class="line"><span class="comment">// and providing a new field called Project.</span></span><br><span class="line"></span><br><span class="line">oGrid.DataSourceID = gridDS.ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add Control to Page</span></span><br><span class="line">Controls.Add(oGrid);</span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<h2 id="Export-to-Excel"><a href="#Export-to-Excel" class="headerlink" title="Export to Excel"></a>Export to Excel</h2><p>I have used this code to Export to excel the filtered items in the table.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">oBtn_Export_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    oGrid.AllowPaging = <span class="literal">false</span>;</span><br><span class="line">    oGrid.AllowSorting = <span class="literal">false</span>;</span><br><span class="line">    oGrid.AllowFiltering = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    System.IO.MemoryStream stream = <span class="keyword">new</span> System.IO.MemoryStream();</span><br><span class="line">    <span class="keyword">using</span> (SpreadsheetDocument document = SpreadsheetDocument.Create(stream, SpreadsheetDocumentType.Workbook, <span class="literal">true</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        DataSet ds = <span class="keyword">new</span> DataSet();</span><br><span class="line">        <span class="keyword">var</span> dv = (DataView)gridDS.Select();</span><br><span class="line">        <span class="keyword">if</span> (dv != <span class="literal">null</span> &amp;&amp; dv.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            DataTable dt = dv.ToTable();</span><br><span class="line">            <span class="comment">//Check to hide columns</span></span><br><span class="line">            List&lt;String&gt; columnsInGrid = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">            <span class="keyword">if</span> (oGrid.HeaderRow != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oGrid.HeaderRow.Cells.Count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    DataControlFieldHeaderCell headerfield = oGrid.HeaderRow.Cells[i] <span class="keyword">as</span> DataControlFieldHeaderCell;</span><br><span class="line">                    DataControlField spbf = headerfield.ContainingField <span class="keyword">as</span> DataControlField;</span><br><span class="line">                    <span class="comment">//Notice that SortException allways must be the same that DataField</span></span><br><span class="line">                    columnsInGrid.Add(spbf.SortExpression); <span class="comment">//["DataField"]);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = dt.Columns.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!columnsInGrid.Contains(dt.Columns[i].ToString()))</span><br><span class="line">                &#123;</span><br><span class="line">                    dt.Columns.RemoveAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ds.Tables.Add(dt);</span><br><span class="line">        &#125;</span><br><span class="line">        ExportExcel.WriteExcelFile(ds, document);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    stream.Flush();</span><br><span class="line">    stream.Position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    Page.Response.ClearContent();</span><br><span class="line">    Page.Response.Clear();</span><br><span class="line">    Page.Response.ClearHeaders();</span><br><span class="line">    Page.Response.Buffer = <span class="literal">true</span>;</span><br><span class="line">    Page.Response.Charset = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  <span class="doctag">NOTE:</span> If you get an "HttpCacheability does not exist" error on the following line, make sure you have</span></span><br><span class="line">    <span class="comment">//  manually added System.Web to this project's References.</span></span><br><span class="line">    <span class="keyword">string</span> filename = <span class="string">"Report.xlsx"</span>;</span><br><span class="line"></span><br><span class="line">    Page.Response.Cache.SetCacheability(System.Web.HttpCacheability.NoCache);</span><br><span class="line">    Page.Response.AddHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment; filename="</span> + filename);</span><br><span class="line">    Page.Response.ContentType = <span class="string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>;</span><br><span class="line">    Page.Response.AddHeader(<span class="string">"Content-Length"</span>, stream.Length.ToString());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] data1 = <span class="keyword">new</span> <span class="keyword">byte</span>[stream.Length];</span><br><span class="line">    stream.Read(data1, <span class="number">0</span>, data1.Length);</span><br><span class="line">    stream.Close();</span><br><span class="line">    Page.Response.BinaryWrite(data1);</span><br><span class="line">    Page.Response.Flush();</span><br><span class="line">    Page.Response.End();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp; </p>
<h2 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h2><p>You can download full code from here: <a href="./SiteCollectionWebPartAggregator.zip">SiteCollectionWebPartAggregator.zip</a></p>
</div><div id="post-content-bottom-space"><p>&nbsp;</p></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://twitter.com/jquintozamora" target="_blank">José Quinto</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/">https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/category/SharePoint/">SharePoint</a><a class="post-meta__tags" href="/category/webpart/">webpart</a></div></article><nav id="pagination"><div class="prev-post pull-left"><a href="/2015/05/19/me-movetolondon/" title="previous page"><i class="fa fa-chevron-left" aria-hidden="true"></i><span>Me.MoveTo('London');</span></a></div><div class="next-post pull-right"><a href="/2014/12/01/expand-all-events-by-default-on-sharepoint-2013-calendars/" title="next page"><span>Expand all events by default on SharePoint 2013 Calendars</span><i class="fa fa-chevron-right" aria-hidden="true"></i></a></div></nav><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'https://blog.josequinto.com/2015/01/30/sharepoint-list-site-collection-web-part-aggregator-using-spsitedataquery-and-spgridview/';
  this.page.identifier = '329';
  this.page.title = 'SharePoint List Site Collection Web Part Aggregator using SPSiteDataQuery and SPGridView';
}
var d = document, s = d.createElement('script');
s.src = "https://https-blog-josequinto-com.disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="//https-blog-josequinto-com.disqus.com/count.js" async></script></section></section></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By José Quinto</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i></div><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.1"></script><script src="/js/fancybox.js?version=1.5.1"></script><script src="/js/copy.js?version=1.5.1"></script><script src="/js/scroll.js?version=1.5.1"></script><script src="/js/head.js?version=1.5.1"></script><script src="/js/search/algolia.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-44570510-1', 'auto');
ga('send', 'pageview');</script><script async src="https://www.google-analytics.com/analytics.js"></script><link rel="manifest" href="/manifest.json"><script async src="/js/registerServiceWorker.js"></script></body></html>